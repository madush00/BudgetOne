<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국아이치(주) - Water Meter Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Added Chart.js CDN -->
    <style>
        /* General Body Styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        /* Main Header (h1) Styles */
        h1 {
            color: #337ab7;
            text-align: center;
            padding: 20px 0;
            margin-top: 0; /* Remove default margin */
        }

        /* Section Styles */
        section {
            background: #fff;
            padding: 20px;
            margin: 20px auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-width: 960px; /* Control maximum width of sections */
        }

        /* Form Styles */
        form {
            display: flex;
            flex-direction: column;
        }

        form div {
            margin-bottom: 10px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Important for width calculation */
        }

        /* Button Styles */
        button {
            background-color: #337ab7;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em; /* Consistent font size */
        }

        button:hover {
            background-color: #286090; /* Darker blue on hover */
        }

        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        /* Specific Section Styling */
        #loginSection {
            width: 350px; /* Adjusted width for better appearance */
            margin: 50px auto;
        }

        #mainContentSection header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        #userInfo {
            font-weight: bold;
        }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        .error-message {
            color: red;
            font-size: 0.9em;
        }

        /* Minor adjustments for headings within sections */
        section h2 {
            margin-top: 0;
            color: #337ab7;
        }
        section h3 {
            margin-top: 15px;
            color: #555;
        }
         section h4 {
            margin-top: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>한국아이치(주) - Water Meter Management System</h1>

    <section id="loginSection">
        <h2>Login</h2>
        <form id="loginForm">
            <div>
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div>
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <button type="submit">Login</button>
        </form>
    </section>

    <section id="mainContentSection" style="display:none;">
        <header>
            <p id="userInfo"></p>
            <button id="logoutButton">Logout</button>
        </header>

        <section id="dashboardSection">
            <h2>Dashboard</h2>
            <div id="manufacturingChartContainer">
                <p>Manufacturing Chart Placeholder</p>
            </div>
            <div id="salesChartContainer">
                <p>Sales Chart Placeholder</p>
            </div>
            <div id="revenueDisplay">
                <p>Revenue Display Placeholder (Admin Only)</p>
            </div>
        </section>

        <section id="adminSection">
            <h2>Admin</h2>
            <section id="userManagementSection">
                <h3>User Management</h3>
                <form id="addUserForm">
                    <h4>Add User</h4>
                    <div>
                        <label for="addUsername">Username:</label> <!-- Changed ID -->
                        <input type="text" id="addUsername" name="addUsername" required>
                    </div>
                    <div>
                        <label for="addUserPassword">Password:</label> <!-- Changed ID -->
                        <input type="password" id="addUserPassword" name="addUserPassword" required>
                    </div>
                    <div>
                        <label for="addUserRole">Role:</label> <!-- Changed ID -->
                        <select id="addUserRole" name="addUserRole">
                            <option value="user">User</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit">Add User</button>
                </form>
                <table id="userListTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- User list will be populated here -->
                    </tbody>
                </table>
            </section>

            <section id="productManagementSection">
                <h3>Product Management</h3>
                <form id="productForm"> <!-- Changed ID -->
                    <h4>Add/Edit Product</h4>
                    <input type="hidden" id="editProductId"> <!-- Added hidden field -->
                    <div>
                        <label for="productName">Product Name:</label> <!-- Changed from productType -->
                        <input type="text" id="productName" name="productName" required>
                    </div>
                    <div>
                        <label for="productManufacturingDate">Manufacturing Date:</label> <!-- Changed ID -->
                        <input type="date" id="productManufacturingDate" name="productManufacturingDate" required>
                    </div>
                    <div>
                        <label for="productInitialQuantity">Initial Quantity:</label> <!-- Changed label and ID -->
                        <input type="number" id="productInitialQuantity" name="productInitialQuantity" required>
                    </div>
                    <button type="submit" id="productSubmitButton">Add Product</button> <!-- Added ID, changed text -->
                </form>
                <table id="productListTable">
                    <thead>
                        <tr>
                            <th>Name</th> <!-- Changed from Type -->
                            <th>Mfg. Date</th>
                            <th>Total Qty</th>
                            <th>Sold Qty</th>
                            <th>Current Qty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Product list will be populated here -->
                    </tbody>
                </table>
            </section>
        </section>

        <section id="managerSection">
            <h2>Manager Tools</h2>
            <section id="manufacturingInputSection">
                <h3>Add Manufacturing Record</h3> <!-- Updated Heading -->
                <form id="manufacturingForm">
                    <div>
                        <label for="manufacturingProductSelect">Select Product:</label>
                        <select id="manufacturingProductSelect" name="manufacturingProductSelect" required>
                            <!-- Product options will be populated here by populateManufacturingProductSelect -->
                        </select>
                    </div>
                    <div>
                        <label for="manufacturingDateInput">Manufacturing Date:</label> <!-- Updated ID -->
                        <input type="date" id="manufacturingDateInput" name="manufacturingDateInput" required>
                    </div>
                    <div>
                        <label for="manufacturingQuantityInput">Quantity Manufactured:</label> <!-- Updated ID and Label -->
                        <input type="number" id="manufacturingQuantityInput" name="manufacturingQuantityInput" min="1" required>
                    </div>
                    <button type="submit">Add Manufacturing Data</button>
                </form>
            </section>
        </section>

        <section id="userSection">
            <h2>User Tools</h2> <!-- Changed heading -->
            <section id="salesInputSection">
                <h3>Record Sale</h3> <!-- Changed heading -->
                <form id="salesForm">
                    <div>
                        <label for="salesProductSelect">Select Product:</label> <!-- Changed ID -->
                        <select id="salesProductSelect" name="salesProductSelect" required>
                            <!-- Product options will be populated here by populateSalesProductSelect -->
                        </select>
                    </div>
                    <div>
                        <label for="saleDateInput">Sale Date:</label> <!-- Changed ID -->
                        <input type="date" id="saleDateInput" name="saleDateInput" required>
                    </div>
                    <div>
                        <label for="saleQuantityInput">Quantity Sold:</label> <!-- Changed ID -->
                        <input type="number" id="saleQuantityInput" name="saleQuantityInput" min="1" required>
                    </div>
                    <button type="submit">Record Sale</button> <!-- Changed button text -->
                </form>
            </section>
        </section>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Constants for localStorage keys ---
            const USERS_KEY = 'watermeter_users';
            const PRODUCTS_KEY = 'watermeter_products';
            const SALES_KEY = 'watermeter_sales';
            const MANUFACTURING_KEY = 'watermeter_manufacturing_records';
            // const CURRENT_USER_KEY = 'watermeter_current_user'; // Replaced by sessionStorage

            // --- Constants for sessionStorage keys ---
            const CURRENT_USER_SESSION_KEY = 'watermeter_current_user_session';

            let currentUser = null; // Global variable to hold current user object

            // --- localStorage Helper Functions ---
            function getData(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            }

            function setData(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            // --- Initialization ---
            function initApp() {
                // Check and initialize localStorage arrays
                if (!getData(USERS_KEY)) {
                    setData(USERS_KEY, []);
                }
                if (!getData(PRODUCTS_KEY)) {
                    setData(PRODUCTS_KEY, []);
                }
                if (!getData(SALES_KEY)) {
                    setData(SALES_KEY, []);
                }
                if (!getData(MANUFACTURING_KEY)) {
                    setData(MANUFACTURING_KEY, []);
                }

                // Create default admin if none exists
                let users = getData(USERS_KEY);
                if (!users || users.length === 0) { // Ensure users is an array
                    users = []; // Initialize if null
                    const adminUser = {
                        id: Date.now(),
                        username: 'admin',
                        // IMPORTANT: Storing passwords in plain text is highly insecure.
                        // In a real application, passwords should be hashed and salted.
                        password: 'adminpassword',
                        role: 'admin'
                    };
                    users.push(adminUser);
                    setData(USERS_KEY, users);
                    console.log('Default admin user created.');
                }
                
                checkLoginState(); // Check login state instead of just showing login view
            }

            // --- Authentication ---
            function handleLogin(event) {
                event.preventDefault(); // Prevent form submission
                const usernameInput = document.getElementById('username');
                const passwordInput = document.getElementById('password');
                const username = usernameInput.value;
                const password = passwordInput.value;

                const users = getData(USERS_KEY) || [];
                // IMPORTANT: Direct password comparison is insecure. Use hashing in production.
                const foundUser = users.find(user => user.username === username && user.password === password);

                if (foundUser) {
                    currentUser = foundUser;
                    sessionStorage.setItem(CURRENT_USER_SESSION_KEY, JSON.stringify(currentUser));
                    showMainContentView();
                    updateUIForRole(); 
                    usernameInput.value = ''; // Clear form
                    passwordInput.value = '';
                    // Remove any existing error messages
                    const existingError = document.getElementById('loginErrorMessage');
                    if (existingError) existingError.remove();
                } else {
                    // Display error message
                    let errorMessageElement = document.getElementById('loginErrorMessage');
                    if (!errorMessageElement) {
                        errorMessageElement = document.createElement('p');
                        errorMessageElement.id = 'loginErrorMessage';
                        errorMessageElement.className = 'error-message'; // Use existing CSS class
                        const loginForm = document.getElementById('loginForm');
                        loginForm.appendChild(errorMessageElement);
                    }
                    errorMessageElement.textContent = 'Invalid username or password.';
                }
            }

            function handleLogout() {
                sessionStorage.removeItem(CURRENT_USER_SESSION_KEY);
                currentUser = null;
                showLoginView();
                // Clear user-specific info (already handled by showLoginView)
                console.log('User logged out.');
            }

            function checkLoginState() {
                const sessionUser = sessionStorage.getItem(CURRENT_USER_SESSION_KEY);
                if (sessionUser) {
                    currentUser = JSON.parse(sessionUser);
                    showMainContentView();
                    updateUIForRole();
                } else {
                    showLoginView();
                }
            }

            // --- View Management ---
            function showLoginView() {
                const loginSection = document.getElementById('loginSection');
                const mainContentSection = document.getElementById('mainContentSection');

                if(loginSection) loginSection.style.display = 'block';
                if(mainContentSection) mainContentSection.style.display = 'none';
                
                const userInfoDisplay = document.getElementById('userInfo');
                if (userInfoDisplay) userInfoDisplay.textContent = ''; 
            }

            function showMainContentView() {
                const loginSection = document.getElementById('loginSection');
                const mainContentSection = document.getElementById('mainContentSection');

                if(loginSection) loginSection.style.display = 'none';
                if(mainContentSection) mainContentSection.style.display = 'block';

                if (currentUser) {
                    const userInfoDisplay = document.getElementById('userInfo');
                    if(userInfoDisplay) userInfoDisplay.textContent = `Welcome, ${currentUser.username} (${currentUser.role})`;
                }
            }

            // --- Helper for UI Element Visibility ---
            function toggleElement(elementId, show) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.style.display = show ? 'block' : 'none';
                } else {
                    console.warn(`Element with ID '${elementId}' not found for toggling.`);
                }
            }

            // --- Role-Based UI Update ---
            function updateUIForRole() {
                if (!currentUser) {
                    // This case should ideally be handled by redirecting to login view
                    // or ensuring this function is only called when a user is logged in.
                    console.warn('updateUIForRole called without a current user.');
                    toggleElement('adminSection', false);
                    toggleElement('managerSection', false);
                    toggleElement('userSection', false);
                    toggleElement('dashboardSection', false);
                    return;
                }

                const role = currentUser.role;
                console.log('Updating UI for role:', role);

                // Default state: Hide all role-specific sections and elements first
                toggleElement('adminSection', false);
                toggleElement('managerSection', false);
                toggleElement('userSection', false); // Hide by default, will be shown if user is logged in
                toggleElement('revenueDisplay', false); // Part of dashboard, hide by default
                toggleElement('dashboardSection', false); // Hide by default

                if (currentUser) { // If a user is logged in, show user section and dashboard
                    toggleElement('userSection', true);
                    populateSalesProductSelect(); 
                    toggleElement('dashboardSection', true);
                    // Render charts when dashboard is shown
                    renderManufacturingChart();
                    renderSalesChart();
                }


                // Enable sections based on role
                if (role === 'admin') {
                    toggleElement('adminSection', true);
                    renderUserList(); 
                    renderProductList(); 
                    toggleElement('managerSection', true); 
                    populateManufacturingProductSelect(); 
                    toggleElement('revenueDisplay', true); // Ensure container is visible for admin
                    displayRevenue(); // Display revenue for admin
                } else if (role === 'manager') {
                    toggleElement('managerSection', true);
                    populateManufacturingProductSelect(); 
                    if(revenueDisplay) revenueDisplay.innerHTML = ''; // Clear revenue for non-admin
                    // revenueDisplay visibility is already handled by default state and admin-specific toggle
                } else if (role === 'user') {
                    if(revenueDisplay) revenueDisplay.innerHTML = ''; // Clear revenue for non-admin
                }
            }
            
            // --- View Management (Refinements) ---
            // Overwrite or refine existing showLoginView and showMainContentView
            function showLoginView() {
                toggleElement('loginSection', true);
                toggleElement('mainContentSection', false);
                
                // Explicitly hide all content sections when logging out or showing login view
                toggleElement('dashboardSection', false);
                toggleElement('adminSection', false);
                toggleElement('managerSection', false);
                toggleElement('userSection', false);
                toggleElement('revenueDisplay', false); // Ensure revenue is hidden

                const userInfoDisplay = document.getElementById('userInfo');
                if (userInfoDisplay) userInfoDisplay.textContent = '';
                
                if (typeof resetProductForm === 'function') { // Check if function exists before calling
                    resetProductForm(); // Clear product form on logout/view change
                }
            }

            function showMainContentView() {
                toggleElement('loginSection', false);
                toggleElement('mainContentSection', true);

                if (currentUser) {
                    const userInfoDisplay = document.getElementById('userInfo');
                    if(userInfoDisplay) userInfoDisplay.textContent = `Welcome, ${currentUser.username} (${currentUser.role})`;
                }
                // Note: updateUIForRole() is called separately by handleLogin and checkLoginState
                // after currentUser is confirmed and showMainContentView has made the main area visible.
            }

            // --- Event Listeners ---
            // Ensure the login button exists before adding an event listener
            const loginForm = document.getElementById('loginForm'); // Changed to form for submit event
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            } else {
                console.error("Login form not found. Cannot attach login event listener.");
            }

            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            } else {
                console.error("Logout button not found. Cannot attach logout event listener.");
            }
            
            // Call initApp
            initApp();

            // --- Admin Functionality: User Management ---
            // Moved DOM element selection here to ensure they are found after DOM is ready
            // and to make them accessible to all user management functions.
            const addUserForm = document.getElementById('addUserForm');
            const addUsernameInput = document.getElementById('addUsername');
            const addUserPasswordInput = document.getElementById('addUserPassword');
            const addUserRoleSelect = document.getElementById('addUserRole');
            const userListTableBody = document.getElementById('userListTable') ? document.getElementById('userListTable').querySelector('tbody') : null;

            function renderUserList() {
                if (!userListTableBody) {
                    console.warn('User list table body not found. Skipping renderUserList.');
                    return; 
                }
                const users = getData(USERS_KEY) || [];
                userListTableBody.innerHTML = ''; // Clear existing rows

                users.forEach(user => {
                    const row = userListTableBody.insertRow();
                    row.insertCell().textContent = user.username;
                    row.insertCell().textContent = user.role;

                    const actionsCell = row.insertCell();
                    
                    const resetPassButton = document.createElement('button');
                    resetPassButton.textContent = 'Reset Password';
                    resetPassButton.classList.add('action-button', 'reset-pass-btn');
                    resetPassButton.dataset.userId = user.id;
                    actionsCell.appendChild(resetPassButton);

                    // Add a little space between buttons
                    actionsCell.appendChild(document.createTextNode(' ')); 

                    // Prevent admin from deleting their own current account
                    if (currentUser && currentUser.id !== user.id) {
                        const deleteUserButton = document.createElement('button');
                        deleteUserButton.textContent = 'Delete User';
                        deleteUserButton.classList.add('action-button', 'delete-user-btn');
                        deleteUserButton.dataset.userId = user.id;
                        actionsCell.appendChild(deleteUserButton);
                    } else if (!currentUser) {
                        // If somehow currentUser is null, still add delete for other users (should not happen in admin view)
                         const deleteUserButton = document.createElement('button');
                        deleteUserButton.textContent = 'Delete User (Error State)'; // Should not see this
                        deleteUserButton.classList.add('action-button', 'delete-user-btn');
                        deleteUserButton.dataset.userId = user.id;
                        actionsCell.appendChild(deleteUserButton);
                    }
                });
            }

            function handleAddUser(event) {
                event.preventDefault();
                // Ensure inputs are available
                if (!addUsernameInput || !addUserPasswordInput || !addUserRoleSelect) {
                    alert('User form elements not found. Cannot add user.');
                    return;
                }
                const username = addUsernameInput.value.trim();
                const password = addUserPasswordInput.value; // Don't trim password, allow spaces if intended
                const role = addUserRoleSelect.value;

                if (!username || !password) {
                    alert('Username and password are required.');
                    return;
                }

                const users = getData(USERS_KEY) || [];
                if (users.some(user => user.username === username)) {
                    alert('Username already exists.');
                    return;
                }

                const newUser = {
                    id: Date.now(), 
                    username: username,
                    // IMPORTANT: Storing passwords in plain text is highly insecure.
                    // In a real application, passwords should be hashed and salted.
                    password: password, 
                    role: role
                };
                users.push(newUser);
                setData(USERS_KEY, users);
                renderUserList();
                if(addUserForm) addUserForm.reset();
                alert('User added successfully.');
            }

            function handleDeleteUser(userId) {
                // Ensure userId is treated as a number for comparison if user.id is a number
                const numericUserId = parseInt(userId); 
                if (currentUser && currentUser.id === numericUserId) {
                    alert("You cannot delete your own account.");
                    return;
                }
                if (confirm('Are you sure you want to delete this user?')) {
                    let users = getData(USERS_KEY) || [];
                    users = users.filter(user => user.id !== numericUserId);
                    setData(USERS_KEY, users);
                    renderUserList();
                    alert('User deleted successfully.');
                }
            }

            function handleResetPassword(userId) {
                const numericUserId = parseInt(userId);
                const newPassword = prompt('Enter new password for the user:');
                
                if (newPassword === null) { // User cancelled the prompt
                    return;
                }
                
                if (newPassword.trim() !== "") {
                    let users = getData(USERS_KEY) || [];
                    const userIndex = users.findIndex(user => user.id === numericUserId);
                    if (userIndex > -1) {
                        // IMPORTANT: Storing passwords in plain text is highly insecure.
                        users[users[userIndex].password = newPassword.trim()]; // Update password (still plain text)
                        setData(USERS_KEY, users);
                        alert('Password reset successfully.');
                    } else {
                        alert('User not found.');
                    }
                } else { 
                    alert('Password cannot be empty.');
                }
            }

            // Event Listeners for User Management
            if (addUserForm) {
                addUserForm.addEventListener('submit', handleAddUser);
            } else {
                console.warn('Add user form (addUserForm) not found. Event listener not attached.');
            }

            if (userListTableBody) {
                userListTableBody.addEventListener('click', function(event) {
                    const target = event.target;
                    // Check if the clicked element itself is a button with the class
                    if (target.tagName === 'BUTTON' && target.dataset.userId) {
                        const userId = target.dataset.userId;
                        if (target.classList.contains('delete-user-btn')) {
                            handleDeleteUser(userId);
                        } else if (target.classList.contains('reset-pass-btn')) {
                            handleResetPassword(userId);
                        }
                    }
                });
            } else {
                 console.warn('User list table body not found. Event listeners for delete/reset not attached.');
            }

            // --- Admin Functionality: Product Management ---
            const productForm = document.getElementById('productForm');
            const productNameInput = document.getElementById('productName');
            const productManufacturingDateInput = document.getElementById('productManufacturingDate');
            const productInitialQuantityInput = document.getElementById('productInitialQuantity');
            const editProductIdInput = document.getElementById('editProductId');
            const productSubmitButton = document.getElementById('productSubmitButton');
            const productListTableBody = document.getElementById('productListTable') ? document.getElementById('productListTable').querySelector('tbody') : null;

            function renderProductList() {
                if (!productListTableBody) {
                    console.warn('Product list table body not found. Skipping renderProductList.');
                    return;
                }
                const products = getData(PRODUCTS_KEY) || [];
                productListTableBody.innerHTML = '';

                products.forEach(product => {
                    const row = productListTableBody.insertRow();
                    row.insertCell().textContent = product.name;
                    row.insertCell().textContent = product.manufacturingDate;
                    row.insertCell().textContent = product.totalQuantity;
                    row.insertCell().textContent = product.quantitySold || 0; // Default to 0 if undefined
                    row.insertCell().textContent = (product.totalQuantity || 0) - (product.quantitySold || 0); // Current Quantity

                    const actionsCell = row.insertCell();
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Edit';
                    editButton.classList.add('action-button', 'edit-product-btn');
                    editButton.dataset.productId = product.id;
                    actionsCell.appendChild(editButton);

                    // Add a little space between buttons
                    actionsCell.appendChild(document.createTextNode(' ')); 

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.classList.add('action-button', 'delete-product-btn');
                    deleteButton.dataset.productId = product.id;
                    actionsCell.appendChild(deleteButton);
                });
            }

            function resetProductForm() {
                if (productForm) productForm.reset();
                if (editProductIdInput) editProductIdInput.value = '';
                if (productSubmitButton) productSubmitButton.textContent = 'Add Product';
                // Clear any specific styling or error messages if needed
            }

            function handleProductFormSubmit(event) {
                event.preventDefault();
                // Ensure all input elements are available
                if (!productNameInput || !productManufacturingDateInput || !productInitialQuantityInput || !editProductIdInput) {
                    alert('Product form elements not found. Cannot submit.');
                    return;
                }

                const name = productNameInput.value.trim();
                const manufacturingDate = productManufacturingDateInput.value;
                const initialQuantity = parseInt(productInitialQuantityInput.value);
                const editId = editProductIdInput.value;

                if (!name || !manufacturingDate || isNaN(initialQuantity) || initialQuantity < 0) {
                    alert('Please fill in all product fields correctly. Quantity must be a non-negative number.');
                    return;
                }

                let products = getData(PRODUCTS_KEY) || [];
                if (editId) { // Edit mode
                    const productIndex = products.findIndex(p => p.id === parseInt(editId));
                    if (productIndex > -1) {
                        products[productIndex].name = name;
                        products[productIndex].manufacturingDate = manufacturingDate;
                        products[productIndex].totalQuantity = initialQuantity; 
                        
                        if (products[productIndex].totalQuantity < (products[productIndex].quantitySold || 0)) {
                            alert('Warning: Total quantity is less than quantity already sold. Adjust sales records or quantity.');
                        }
                        setData(PRODUCTS_KEY, products);
                        alert('Product updated successfully.');
                    } else {
                        alert('Product not found for editing.');
                        return; // Exit if product to edit wasn't found
                    }
                } else { // Add mode
                    const newProduct = {
                        id: Date.now(),
                        name: name,
                        manufacturingDate: manufacturingDate,
                        totalQuantity: initialQuantity,
                        quantitySold: 0 // New products have 0 sold
                    };
                    products.push(newProduct);
                    setData(PRODUCTS_KEY, products);
                    alert('Product added successfully.');
                }
                renderProductList();
                resetProductForm();
            }

            function handleEditProduct(productIdString) {
                const productId = parseInt(productIdString);
                const products = getData(PRODUCTS_KEY) || [];
                const product = products.find(p => p.id === productId);
                
                if (product && productNameInput && productManufacturingDateInput && productInitialQuantityInput && editProductIdInput && productSubmitButton) {
                    productNameInput.value = product.name;
                    productManufacturingDateInput.value = product.manufacturingDate;
                    productInitialQuantityInput.value = product.totalQuantity;
                    editProductIdInput.value = product.id; // Ensure this is a string if HTML expects string
                    productSubmitButton.textContent = 'Save Changes';
                    if (productForm) productForm.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Could not find product details or form elements to populate for editing.');
                }
            }

            function handleDeleteProduct(productIdString) {
                const productId = parseInt(productIdString);
                // Note: Deleting a product can orphan sales/manufacturing records.
                // A real system might "soft delete" or prevent deletion if related records exist.
                if (confirm('Are you sure you want to delete this product? This action cannot be undone and might affect existing records.')) {
                    let products = getData(PRODUCTS_KEY) || [];
                    products = products.filter(p => p.id !== productId);
                    setData(PRODUCTS_KEY, products);
                    renderProductList();
                    resetProductForm(); // Clear form if the deleted product was being edited
                    alert('Product deleted successfully.');
                }
            }

            // Event Listeners for Product Management
            if (productForm) {
                productForm.addEventListener('submit', handleProductFormSubmit);
            } else {
                console.warn("Product form (productForm) not found. Event listener not attached.");
            }

            if (productListTableBody) {
                productListTableBody.addEventListener('click', function(event) {
                    const target = event.target;
                    // Check if the clicked element is a button and has a productId dataset property
                    if (target.tagName === 'BUTTON' && target.dataset.productId) {
                        const productId = target.dataset.productId; // dataset always gives string
                        if (target.classList.contains('edit-product-btn')) {
                            handleEditProduct(productId);
                        } else if (target.classList.contains('delete-product-btn')) {
                            handleDeleteProduct(productId);
                        }
                    }
                });
            } else {
                console.warn("Product list table body (productListTableBody) not found. Event listeners for edit/delete not attached.");
            }

            // --- Manager Functionality: Manufacturing Input ---
            const manufacturingForm = document.getElementById('manufacturingForm');
            const manufacturingProductSelect = document.getElementById('manufacturingProductSelect');
            const manufacturingDateInput = document.getElementById('manufacturingDateInput'); 
            const manufacturingQuantityInput = document.getElementById('manufacturingQuantityInput');

            function populateManufacturingProductSelect() {
                if (!manufacturingProductSelect) {
                    console.warn("Manufacturing product select dropdown not found.");
                    return;
                }
                const products = getData(PRODUCTS_KEY) || [];
                manufacturingProductSelect.innerHTML = '<option value="">-- Select a Product --</option>'; // Default option

                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = product.name; // Display product name
                    manufacturingProductSelect.appendChild(option);
                });
            }

            function handleAddManufacturingRecord(event) {
                event.preventDefault();
                // Ensure elements are present before accessing their values
                if (!manufacturingProductSelect || !manufacturingDateInput || !manufacturingQuantityInput) {
                    alert('Manufacturing form elements not found. Cannot add record.');
                    return;
                }

                const productId = manufacturingProductSelect.value;
                const date = manufacturingDateInput.value;
                const quantity = parseInt(manufacturingQuantityInput.value);

                if (!productId || !date || isNaN(quantity) || quantity <= 0) {
                    alert('Please select a product, enter a valid date, and a quantity greater than 0.');
                    return;
                }

                let products = getData(PRODUCTS_KEY) || [];
                const productIndex = products.findIndex(p => p.id === parseInt(productId));

                if (productIndex === -1) {
                    alert('Selected product not found. Please refresh or check product list.');
                    return;
                }

                products[productIndex].totalQuantity = (products[productIndex].totalQuantity || 0) + quantity; // Ensure totalQuantity is initialized
                setData(PRODUCTS_KEY, products);

                // Optional: Create a manufacturing record
                let manufacturingRecords = getData(MANUFACTURING_KEY) || [];
                const newRecord = {
                    id: Date.now(),
                    productId: parseInt(productId),
                    productName: products[productIndex].name, // Store name for easier display later
                    manufacturingDate: date,
                    quantityManufactured: quantity,
                    manufacturedBy: currentUser ? currentUser.username : 'unknown'
                };
                manufacturingRecords.push(newRecord);
                setData(MANUFACTURING_KEY, manufacturingRecords);

                alert(`Successfully added ${quantity} units to product: ${products[productIndex].name}. Total quantity is now ${products[productIndex].totalQuantity}.`);
                if (manufacturingForm) manufacturingForm.reset();
                
                // If current user is admin and product list is visible, refresh it
                if (currentUser && currentUser.role === 'admin' && typeof renderProductList === 'function') {
                    renderProductList();
                }
                // Dashboard will be updated separately later
            }

            // Event Listener for Manufacturing Form
            if (manufacturingForm) {
                manufacturingForm.addEventListener('submit', handleAddManufacturingRecord);
            } else {
                console.warn("Manufacturing form (manufacturingForm) not found. Event listener not attached.");
            }

            // --- User (Employee) Functionality: Sales Input ---
            const salesForm = document.getElementById('salesForm');
            const salesProductSelect = document.getElementById('salesProductSelect');
            const saleDateInput = document.getElementById('saleDateInput'); 
            const saleQuantityInput = document.getElementById('saleQuantityInput');

            function populateSalesProductSelect() {
                if (!salesProductSelect) {
                    console.warn("Sales product select dropdown not found.");
                    return;
                }
                const products = getData(PRODUCTS_KEY) || [];
                salesProductSelect.innerHTML = '<option value="">-- Select a Product --</option>'; // Default option

                products.forEach(product => {
                    const currentStock = (product.totalQuantity || 0) - (product.quantitySold || 0);
                    if (currentStock > 0) { // Only list products with available stock
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (Stock: ${currentStock})`; // Display name and current stock
                        salesProductSelect.appendChild(option);
                    }
                });
            }

            function handleAddSaleRecord(event) {
                event.preventDefault();
                // Ensure form elements are available
                if (!salesProductSelect || !saleDateInput || !saleQuantityInput) {
                    alert('Sales form elements not found. Cannot record sale.');
                    return;
                }

                const productId = salesProductSelect.value;
                const date = saleDateInput.value;
                const quantity = parseInt(saleQuantityInput.value);

                if (!productId || !date || isNaN(quantity) || quantity <= 0) {
                    alert('Please select a product, enter a valid date, and a quantity greater than 0.');
                    return;
                }

                let products = getData(PRODUCTS_KEY) || [];
                const productIndex = products.findIndex(p => p.id === parseInt(productId));

                if (productIndex === -1) {
                    alert('Selected product not found. Please refresh or check product list.');
                    return;
                }

                const product = products[productIndex];
                const currentStock = (product.totalQuantity || 0) - (product.quantitySold || 0);

                if (quantity > currentStock) {
                    alert(`Not enough stock for ${product.name}. Available: ${currentStock}, Requested: ${quantity}.`);
                    return;
                }

                products[productIndex].quantitySold = (products[productIndex].quantitySold || 0) + quantity;
                setData(PRODUCTS_KEY, products);

                // Recommended: Create a sales record
                let salesRecords = getData(SALES_KEY) || [];
                const newRecord = {
                    id: Date.now(),
                    productId: parseInt(productId),
                    productName: product.name, // Store name for easier display later
                    saleDate: date,
                    quantitySold: quantity,
                    soldBy: currentUser ? currentUser.username : 'unknown'
                };
                salesRecords.push(newRecord);
                setData(SALES_KEY, salesRecords);

                const updatedStock = products[productIndex].totalQuantity - products[productIndex].quantitySold;
                alert(`Successfully recorded sale of ${quantity} units of ${product.name}. Stock remaining: ${updatedStock}.`);
                
                if (salesForm) salesForm.reset();
                populateSalesProductSelect(); // Refresh product list in select, as stock has changed

                // If current user is admin and product list is visible, refresh it
                if (currentUser && currentUser.role === 'admin' && typeof renderProductList === 'function') {
                    renderProductList();
                }
                // Dashboard will be updated separately later
                // Update charts if dashboard is visible
                if (document.getElementById('dashboardSection').style.display === 'block') {
                    renderManufacturingChart();
                    renderSalesChart();
                    if (currentUser && currentUser.role === 'admin') displayRevenue();
                }
            }

            // Event Listener for Sales Form
            if (salesForm) {
                salesForm.addEventListener('submit', handleAddSaleRecord);
            } else {
                console.warn("Sales form (salesForm) not found. Event listener not attached.");
            }

            // --- Dashboard & Charting ---
            const manufacturingChartContainer = document.getElementById('manufacturingChartContainer');
            const salesChartContainer = document.getElementById('salesChartContainer');
            const revenueDisplay = document.getElementById('revenueDisplay'); // Already declared earlier for admin section
            let manufacturingChartInstance = null;
            let salesChartInstance = null;
            const FIXED_PRICE_PER_UNIT = 10; // Assumption for revenue calculation

            function renderManufacturingChart() {
                if (!manufacturingChartContainer) {
                    console.warn('Manufacturing chart container not found.');
                    return;
                }
                const products = getData(PRODUCTS_KEY) || [];
                
                let canvas = manufacturingChartContainer.querySelector('canvas');
                if (!canvas) {
                    canvas = document.createElement('canvas');
                    // Clear placeholder content if any
                    manufacturingChartContainer.innerHTML = ''; 
                    manufacturingChartContainer.appendChild(canvas);
                }
                const ctx = canvas.getContext('2d');

                if (manufacturingChartInstance) {
                    manufacturingChartInstance.destroy();
                }
                manufacturingChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: products.map(p => p.name),
                        datasets: [{
                            label: 'Quantity Manufactured (Total Stock)',
                            data: products.map(p => p.totalQuantity),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } } 
                    }
                });
            }

            function renderSalesChart() {
                if (!salesChartContainer) {
                    console.warn('Sales chart container not found.');
                    return;
                }
                const products = getData(PRODUCTS_KEY) || [];

                let canvas = salesChartContainer.querySelector('canvas');
                if (!canvas) {
                    canvas = document.createElement('canvas');
                    // Clear placeholder content if any
                    salesChartContainer.innerHTML = ''; 
                    salesChartContainer.appendChild(canvas);
                }
                const ctx = canvas.getContext('2d');

                if (salesChartInstance) {
                    salesChartInstance.destroy();
                }
                salesChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: products.map(p => p.name),
                        datasets: [{
                            label: 'Quantity Sold',
                            data: products.map(p => p.quantitySold || 0), // Ensure quantitySold is at least 0
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } } 
                    }
                });
            }

            function displayRevenue() {
                if (!revenueDisplay) { // Check if the element exists
                    console.warn('Revenue display element not found.');
                    return;
                }
                if (!currentUser || currentUser.role !== 'admin') {
                    revenueDisplay.innerHTML = ''; // Clear if not admin or element doesn't exist for some reason
                    return;
                }
                const products = getData(PRODUCTS_KEY) || [];
                let totalRevenue = 0;
                products.forEach(product => {
                    totalRevenue += (product.quantitySold || 0) * FIXED_PRICE_PER_UNIT;
                });
                // Comment: Revenue is estimated based on a fixed price per unit.
                revenueDisplay.innerHTML = `<h4>Total Estimated Revenue: $${totalRevenue.toFixed(2)} <small>(at $${FIXED_PRICE_PER_UNIT}/unit)</small></h4>`;
            }

            // --- Update chart calls in existing functions ---
            // Function handleAddManufacturingRecord
            // Original: if (currentUser && currentUser.role === 'admin' && typeof renderProductList === 'function') { renderProductList(); }
            // New logic:
            const originalHandleAddManufacturingRecord = handleAddManufacturingRecord;
            handleAddManufacturingRecord = function(event) {
                originalHandleAddManufacturingRecord.call(this, event); // Call original function
                if (document.getElementById('dashboardSection').style.display === 'block') {
                    renderManufacturingChart();
                    renderSalesChart(); // Sales chart might not change but manufacturing could affect "available for sale" perception
                    if (currentUser && currentUser.role === 'admin') displayRevenue(); // Revenue might change if price is per manufactured item (not the case here, but good practice)
                }
            }

            // Function handleProductFormSubmit (for Admin adding/editing products)
            const originalHandleProductFormSubmit = handleProductFormSubmit;
            handleProductFormSubmit = function(event) {
                originalHandleProductFormSubmit.call(this, event);
                if (document.getElementById('dashboardSection').style.display === 'block') {
                    renderManufacturingChart();
                    renderSalesChart();
                    if (currentUser && currentUser.role === 'admin') displayRevenue();
                }
            }

            // Function handleDeleteProduct (for Admin deleting products)
            const originalHandleDeleteProduct = handleDeleteProduct;
            handleDeleteProduct = function(productIdString) {
                originalHandleDeleteProduct.call(this, productIdString);
                if (document.getElementById('dashboardSection').style.display === 'block') {
                    renderManufacturingChart();
                    renderSalesChart();
                    if (currentUser && currentUser.role === 'admin') displayRevenue();
                }
            }
        });
    </script>
</body>
</html>
